#PCOA
rm(list = ls())#清除环境变量
#安装与加载包
#install.packages("ggplot2")
#install.packages("openxlsx")
#install.packages("vegan")
library(ggplot2)
library(openxlsx)
library(vegan)
data <- read.table(".txt",
                   header = TRUE,
                   row.names = 1,
                   sep = "\t",
                   check.names = FALSE)

# 读取分组信息（同理，第一列是样品名）
group <- read.table(".txt",
                    header = TRUE,
                    row.names = 1,
                    sep = "\t",
                    check.names = FALSE)

# 计算样本间的距离，该函数默认计算行向量间的距离
# vegdist函数，计算距离；method参数，选择距离类型,根据实际需求选择；diag，是否显示对角线；upper，是否显示上斜对角
?vegdist#查看参数
dist = vegdist(t(data), method="bray",diag=T, upper=T)
dist
dist <- as.matrix(dist)
# 对加权距离进行PCoA分析
pcoa = cmdscale(dist, eig=T)
# 提取各维度的占比与解释率
eig = summary(eigenvals(pcoa))
head(eig)

#设置各维度的名字，从PCoA1开始
axis = paste0("PCoA", 1:ncol(eig))
axis
#各轴解释率
eig = data.frame(Axis = axis, t(eig)[, -3])
head(eig)
pco1 = round(eig[1, 3] * 100, 2)
pco2 = round(eig[2, 3] * 100, 2)
# 设置画图时的x轴和y轴的标题，衔接逗号中的内容
xlab = paste0("PCoA1 (",pco1,"%)")
ylab = paste0("PCoA2 (",pco2,"%)")
# 获取各样本在前两个维度的坐标
pcoa_points = as.data.frame(pcoa$points)
pcoa_points
#合并样本坐标和对应的分组信息
pcoa_points = data.frame(pcoa_points, group = group[1])
pcoa_points#绘图数据
p = ggplot(pcoa_points,aes(V1,V2)) +
  geom_point(size=4,aes(color=group,shape = group))+     #按分组画点的颜色和形状
  #geom_polygon(data = group_border, aes(fill = group),alpha=0.6)+  #填充颜色，设置颜色透明度
  geom_text(aes(label=rownames(pcoa_points)), size=4, vjust=1, hjust=0)+  #添加样本名称,名称位置大小
  labs(x=xlab,y=ylab)+ #添加x、y轴标题和图标题
  stat_ellipse(aes(fill = group), geom = 'polygon', level = 0.95, alpha = 0.1, show.legend = FALSE) + #添加置信椭圆
  theme(plot.title = element_text(size = 12,hjust = 0.5))+
  geom_hline(yintercept=0, linetype=4) +        #添加原点垂直辅助线
  geom_vline(xintercept=0 ,linetype=4)+  #添加原点水平辅助线
  theme_bw()+
  theme(plot.title = element_text(hjust = 0.5))+
  theme(panel.grid.major=element_blank(),panel.grid.minor=element_blank())
p
rm(list = ls()) #删除Enviroment中所有的数据

#读取 OTU 丰度表并转换为数据框
otu <- read.delim('amfpcoa.txt', row.names = 1,  stringsAsFactors = FALSE)

head(otu)

otu <- data.frame(t(otu))
group <- read.delim('amffenzu.txt',  stringsAsFactors = FALSE)

head(group)
library(vegan)

#设置随机种子，让结果可重现,为了防止有人质疑对随机种子的选择,随机生成种子

seed <- sample(.Machine$integer.max, size=1)

seed

set.seed(seed)

#执行PERMANOVA

#样本间成对距离选择时,物种多样性中最常使用 Bray-curtis 距离,并通过999次置换估计P值

adonis_group <- adonis2(otu~group, group,  distance = 'bray', permutations = 999)

adonis_group
